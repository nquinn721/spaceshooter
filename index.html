<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Space Fighter</title>
	<style>
	canvas{
		border:1px solid black;
	}
	canvas, .connected{
		float: left;
	}
	.connected {
	    position: fixed;
	    right: 0;
	    background: #222;
	    color: white;
	    padding: 0 20px;
	}
	</style>
	<script src="js/jquery-2.2.3.min.js"></script>
</head>
<body>
<canvas id="actual-game" width="300" height="300"></canvas>
<canvas id="space-fighter" width="400" height="400"></canvas>
<div class="connected">
	<h3>Connected Sockets</h3>
	<div class="sockets"></div>
	<h3>Visible Players</h3>
	<div class="visible-sockets">
		
	</div>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
var io = io.connect(),
	canvas = document.getElementById('space-fighter'),
	ctx = canvas.getContext('2d'),
	gameCanvas = document.getElementById('actual-game'),
	gameCtx = gameCanvas.getContext('2d'),
	segment, segments, subscribed;

io.on('canvas', function(gridSize, segmentSize) {
	canvas.width = gridSize.width / 2;
	canvas.height = gridSize.height / 2;
	segment = segmentSize;
});
io.on('grid', function(seg) {
	segments = seg;
});


var items = [];
var player;
var connected;

io.on('player', function(p) {
	player = p;
});
io.on('items', function(itemList) {
	items = itemList;
	showVisible();
});
io.on('remove item', function(item) {
	removeItem(item);
	showVisible();
});
io.on('add item', function(item) {
	items.push(item);
	showVisible();
});
io.on('moved', function(item) {
	if(item.id === player.id)
		player = item;
	replaceItem(item);
});
io.on('connected sockets', function(sockets) {
	connected = sockets;
	showConnected();
});
io.on('subscribed segments', function(segments) {
	subscribed = segments;
});

function showVisible() {
	$('.visible-sockets').html('');
	for(var i = 0; i < items.length; i++)
		$('.visible-sockets').append($('<div>', {text : items[i].id}));
}
function showConnected() {
	$('.sockets').html('');
	for(var i = 0; i < connected.length; i++)
		$('.sockets').append($('<div>', {text : connected[i].id}));
}
function getItem(item) {
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id)return item;
}
function replaceItem(item) {
	var found;
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id){
			found = true;
			items[i] = item;
		}
	if(!found)items.push(item);
}
function removeItem(item) {
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id)items.splice(i,1);
}
$(document).on('keydown', function (e) {
	var k = e.keyCode;

	if(k === 38)
		io.emit('move', 'up');
	if(k === 40)
		io.emit('move', 'down');
	if(k === 37)
		io.emit('move', 'left');
	if(k === 39)
		io.emit('move', 'right');
	if(k === 32)
		io.emit('shoot');
}).on('keyup', function() {
	io.emit('stopmove');
});
var drawn;
var logged;
var loggedSubscribed;
function draw() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
	gameCtx.clearRect(0,0,gameCanvas.width,gameCanvas.height);

	if(player){
		gameCtx.save();
		gameCtx.translate(-player.x + 150, -player.y + 150);
		for(var i = 0; i < items.length; i++)
			if(items[i].id !== player.id)
				gameCtx.fillRect(items[i].x, items[i].y, items[i].w, items[i].h);
		gameCtx.restore();
		gameCtx.fillRect(150, 150, player.w, player.h);
	}




	for(var i = 0; i < items.length; i++){
		ctx.fillStyle = "black"; 
		ctx.fillRect(
			items[i].x / 2, 
			items[i].y / 2, 
			items[i].w / 2, 
			items[i].h / 2
		);
	}
	// ctx.fillStyle = '#aaa';

	// gameCtx.fillStyle = 'black';

	
		
	// if(segments){
	// 	for(var i = 0; i < segments.length; i++){
	// 		var x = segments[i].x,
	// 			y = segments[i].y,
	// 			w = segments[i].w,
	// 			h = segments[i].h;

	// 		ctx.rect(x, y, w, h);
	// 		ctx.fillStyle = "#aaa"; 
	// 		ctx.fillText('[' + (y / 100) + ',' + (x / 100) + ']',x + (w / 2) - 15,y + (h / 2));
	// 	}
	// 		ctx.stroke();
	// }

	if(subscribed){
		if(!loggedSubscribed){
			console.log(subscribed);
			loggedSubscribed = true;
		}
		ctx.fillStyle = 'rgba(243, 177, 255, 0.72)';
		for(var i = 0; i < subscribed.length; i++){
			ctx.fillRect(subscribed[i].x  / 2, subscribed[i].y  / 2, subscribed[i].w / 2, subscribed[i].h / 2);
		}
		// drawSubscribed();
	}
	
	requestAnimationFrame(draw);
}
draw();


function drawSubscribed() {
	var s = subscribed[0],
		h = s.h / 2,
		w = s.w / 2,
		zero = subscribed[0],
		one = subscribed[1],
		two = subscribed[2],
		three = subscribed[3],
		four = subscribed[4],
		five = subscribed[5],
		six = subscribed[6],
		seven = subscribed[7],
		eight = subscribed[8];

	if(zero)
		ctx.fillRect(zero.x + w, zero.y + h, w, h);
	if(one)
		ctx.fillRect(one.x , one.y + h, w, h);
	if(two)
		ctx.fillRect(two.x - w, two.y + h, w, h);
	if(three)
		ctx.fillRect(three.x + w, three.y, w, h);
	if(four)
		ctx.fillRect(four.x, four.y, w, h);
	if(five)
		ctx.fillRect(five.x - w, five.y, w, h);
	if(six)
		ctx.fillRect(six.x + w, six.y - h, w, h);
	if(seven)
		ctx.fillRect(seven.x, seven.y - h, w, h);
	if(eight)
		ctx.fillRect(eight.x - w, eight.y - h, w, h);
}


</script>

</body>
</html>