<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Space Fighter</title>
	<style>
	canvas{
		border:1px solid black;
	}
	</style>
	<script src="js/jquery-2.2.3.min.js"></script>
</head>
<body>
<canvas id="space-fighter" width="400" height="400"></canvas>
<script src="/socket.io/socket.io.js"></script>
<script>
var io = io.connect(),
	canvas = document.getElementById('space-fighter'),
	ctx = canvas.getContext('2d'),
	segment, segments;

io.on('canvas', function(gridSize, segmentSize) {
	canvas.width = gridSize.width;
	canvas.height = gridSize.height;
	segment = segmentSize;
});
io.on('grid', function(seg) {
	segments = seg;
});


var items = [];

io.on('items', function(itemList) {
	items = itemList;
});
io.on('remove item', function(item) {
	removeItem(item);
});
io.on('add item', function(item) {
	console.log('add', item);
	items.push(item);
});
io.on('moved', function(item) {
	console.log('moved', item.x, item.y, item.w, item.h, item.id, items);
	replaceItem(item);
});
function getItem(item) {
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id)return item;
}
function replaceItem(item) {
	var found;
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id){
			found = true;
			items[i] = item;
		}
	if(!found)items.push(item);
}
function removeItem(item) {
	for(var i = 0; i < items.length; i++)
		if(items[i].id === item.id)items.splice(i,1);
}
$(document).on('keydown', function (e) {
	var k = e.keyCode;

	if(k === 38)
		io.emit('move', 'up');
	if(k === 40)
		io.emit('move', 'down');
	if(k === 37)
		io.emit('move', 'left');
	if(k === 39)
		io.emit('move', 'right');
	if(k === 32)
		io.emit('shoot');
}).on('keyup', function() {
	io.emit('stopmove');
});
var drawn;
function draw() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
	for(var i = 0; i < items.length; i++){
		ctx.fillStyle = "black"; 
		ctx.fillRect(items[i].x, items[i].y, items[i].w, items[i].h);
	}
	ctx.fillStyle = '#aaa';

	if(segments){
		for(var i = 0; i < segments.length; i++){
			var x = segments[i].x,
				y = segments[i].y,
				w = segments[i].w,
				h = segments[i].h;

			ctx.rect(x, y, w, h);
			ctx.fillStyle = "#aaa"; 
			ctx.fillText('[' + (y / 100) + ',' + (x / 100) + ']',x + (w / 2) - 15,y + (h / 2));
		}
			ctx.stroke();
	}
	
	requestAnimationFrame(draw);
}
draw();



</script>

</body>
</html>